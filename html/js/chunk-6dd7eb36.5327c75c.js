(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-6dd7eb36"],{"338d":function(e,t,a){},"729e":function(e,t,a){"use strict";a.r(t);var r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("one-tabel",{staticClass:"one-tabel"},[a("actions",{staticClass:"actions",attrs:{slot:"header",options:e.actionsOptions},on:{add:function(t){return e.openEditModal("add")},edit:function(t){return e.openEditModal("edit")},execute:e.openSqlExcuteModal,remove:e.remove},slot:"header"}),a("div",{staticClass:"data-table"},[a("ag-grid",{ref:"fitGrid",staticClass:"ag-theme-material",staticStyle:{width:"100%",height:"100%"},attrs:{gridOptions:e.gridOptions,modules:e.modules}})],1),a("edit-modal",{ref:"editModalVueComponent",attrs:{loading:e.editModal.loading},on:{cancel:e.cancelEditModal,ok:e.confirmEditModal}},[a("Form",{ref:"editModalFormVueComponent",attrs:{"label-width":80,model:e.editModal.data,rules:e.editModal.rules}},[a("FormItem",{attrs:{label:e.$t("system.sqlManager.label.code"),prop:"code"}},[a("Input",{attrs:{disabled:"edit"==e.modalConfirmActionType},model:{value:e.editModal.data.code,callback:function(t){e.$set(e.editModal.data,"code",t)},expression:"editModal.data.code"}})],1),a("FormItem",{attrs:{label:e.$t("system.sqlManager.label.sql"),prop:"content"}},[a("Input",{attrs:{placeholder:e.$t("system.sqlManager.rules.sqlContent"),rows:4,type:"textarea"},model:{value:e.editModal.data.content,callback:function(t){e.$set(e.editModal.data,"content",t)},expression:"editModal.data.content"}})],1),a("FormItem",{attrs:{label:e.$t("system.userManager.role"),prop:"roles"}},[a("CheckboxGroup",{model:{value:e.editModal.data.roles,callback:function(t){e.$set(e.editModal.data,"roles",t)},expression:"editModal.data.roles"}},e._l(e.roleTypes,(function(t){return a("Checkbox",{key:t.name,attrs:{label:t.name}},[a("span",[e._v("\n              "+e._s(e.getRoleDisplayText("common.enums.roleType."+t.name,t.name))+"\n            ")])])})),1)],1),a("FormItem",{attrs:{label:e.$t("system.sqlManager.label.description"),prop:"description"}},[a("Input",{attrs:{rows:4,type:"textarea"},model:{value:e.editModal.data.description,callback:function(t){e.$set(e.editModal.data,"description",t)},expression:"editModal.data.description"}})],1)],1)],1),a("Modal",{attrs:{"mask-closable":!1,"ok-text":e.$t("common.actions.execute"),title:e.$t("system.sqlManager.label.viewSqlResult"),width:"960"},on:{"on-cancel":e.cancelSqlExcuteModal},model:{value:e.showSqlExcuteModal,callback:function(t){e.showSqlExcuteModal=t},expression:"showSqlExcuteModal"}},[a("Row",[a("Col",{attrs:{span:"12"}},[a("Form",{ref:"formDynamic",attrs:{"label-width":80,model:e.formDynamic}},[a("FormItem",{attrs:{label:"SQL语句"}},[a("Row",[a("Col",{attrs:{span:"24"}},[a("Input",{attrs:{rows:4,disabled:"",type:"textarea"},model:{value:e.excutedSqlContent,callback:function(t){e.excutedSqlContent=t},expression:"excutedSqlContent"}})],1)],1)],1),e._l(e.formDynamic.items,(function(t,r){return a("FormItem",{key:r,attrs:{label:"变量 "+t.variableName}},[a("Row",[a("Col",{attrs:{span:"18"}},[a("Input",{attrs:{placeholder:"请输入变量值",type:"text"},model:{value:t.variableValue,callback:function(a){e.$set(t,"variableValue",a)},expression:"item.variableValue"}})],1),a("Col",{attrs:{span:"6"}},[a("Select",{model:{value:t.variableJsType,callback:function(a){e.$set(t,"variableJsType",a)},expression:"item.variableJsType"}},e._l(e.jsTypes,(function(e){return a("Option",{key:e,attrs:{label:e,value:e}})})),1)],1)],1)],1)}))],2)],1),a("Col",{staticStyle:{padding:"6px"},attrs:{span:"12"}},[a("div",{staticClass:"sqlExcuteResult"},[a("code",[e._v(e._s(e.sqlExcuteResult))])])])],1),a("div",{attrs:{slot:"footer"},slot:"footer"},[a("Button",{attrs:{size:"large",type:"primary"},on:{click:e.okSqlExcuteModal}},[e._v(e._s(e.$t("common.actions.execute")))])],1)],1)],1)},n=[],s=a("53ca"),i=(a("c5f6"),a("ac6a"),a("96cf"),a("1da1")),o=(a("4917"),a("3b2b"),a("23f4")),l=a("9b95"),c=a("9974b"),d=a("e7f7"),u=a("db25"),m=a("3595"),p=a("6ad0"),h=a("6689"),g=a("d2b0"),f=a("8eac"),b=(a("b893"),a("5946"));var v={name:"sql-fragment-manager",components:{oneTabel:o["b"],actions:l["a"],editModal:f["a"]},mixins:[d["a"],u["a"],b["a"]],data:function(){var e=this;return{jsTypes:["string","number"],excuteModalLoading:!0,excutedSqlContent:"",formDynamic:{items:[]},showSqlExcuteModal:!1,sqlExcuteResult:"",roleTypes:[],modules:c["a"],gridOptions:this.$_.assign(this.$agGetDefaultGridOptions(),{onGridReady:e.onGridReady,onSelectionChanged:e.onSelectionChanged,pagination:!0,columnDefs:[{type:["rowNumberColumn"]},{headerName:"编码",field:"code",sort:"asc"},{headerName:"sql语句",field:"content",width:600},{headerName:this.$t("common.labels.createdAt"),field:"createdAt",cellRendererFramework:m["a"],filter:"agDateColumnFilter",width:200},{headerName:this.$t("common.labels.updatedAt"),cellRendererFramework:m["a"],field:"updatedAt",filter:"agDateColumnFilter",width:200},{headerName:this.$t("common.labels.description"),field:"description",filter:"agTextColumnFilter"}]}),gridApi:null,columnApi:null,selectedRow:null,modalConfirmActionType:"add",actionsOptions:{add:{visible:!0,disabled:!1,loading:!1},edit:{visible:!0,disabled:!0},remove:{visible:!0,disabled:!0},execute:{visible:!0,disabled:!0}},editModal:{loading:!1,visible:!1,data:e.getDefaultSqlFragment(),rules:{code:[{required:!0,message:this.$t("system.sqlManager.rules.code"),trigger:"blur"},{message:this.$t("system.sqlManager.rules.codeValidateError"),trigger:"change",validator:function(e,t,a){var r=new RegExp(/(^[A-Za-z]+[A-Za-z0-9_]+$)/gi);r.test(t)?a():a(new Error)}}],content:[{required:!0,message:this.$t("system.sqlManager.rules.sqlContent"),trigger:"blur"},{message:this.$t("system.sqlManager.rules.sqlContent"),validator:function(e,t,a){var r=t.trim();";"!=r.charAt(r.length-1)||r.match(/\;/g).length>1?a(new Error):a()},trigger:"change"}],roles:[{required:!0,message:this.$t("system.sqlManager.rules.role"),trigger:"change",type:"array",min:1}]}}}},methods:{openSqlExcuteModal:function(){this.excutedSqlContent=this.selectedRow.content;var e=this.getVariablesByParseSql(this.excutedSqlContent);this.formDynamic.items=e,this.showSqlExcuteModal=!0},getVariablesByParseSql:function(e){var t,a=/(\@)(\w+)/g,r=e.match(a);return t=r&&r.length>0?r.map((function(e){var t=e.substring(1);return{variableName:t,variableValue:"",variableJsType:"string"}})):[],t},okSqlExcuteModal:function(){var e=Object(i["a"])(regeneratorRuntime.mark((function e(){var t,a,r,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=this.selectedRow.code,a={},this.formDynamic.items.forEach((function(e){if(e.variableValue.trim().length>0){var t=e.variableValue;a[e.variableName]="number"==e.variableJsType?Number(t):t}})),e.prev=3,e.next=6,this.callGraphQlMution(g["c"],{code:t,params:a});case 6:r=e.sent,n=r.data.db_SQLFragmentCheck,this.sqlExcuteResult=JSON.stringify(n),e.next=14;break;case 11:e.prev=11,e.t0=e["catch"](3),this.sqlExcuteResult=JSON.stringify(e.t0.networkError.extensions.exception[0].message);case 14:case"end":return e.stop()}}),e,this,[[3,11]])})));function t(){return e.apply(this,arguments)}return t}(),cancelSqlExcuteModal:function(){this.showSqlExcuteModal=!1,this.sqlExcuteResult="",this.formDynamic.items=[],this.excutedSqlContent="",this.disabledSomeAction(),this.gridApi.deselectAll()},getRoleDisplayText:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return e&&this.existI18N(e)?this.$t(e):t},existI18N:function(e){var t=this.$t(e);return!0===this.$te(e)&&"object"!==Object(s["a"])(t)},cancelEditModal:function(){this.disabledSomeAction(),this.$refs.editModalFormVueComponent.resetFields(),this.$refs.editModalVueComponent.close(),this.gridApi.deselectAll()},isCodeExists:function(){var e=Object(i["a"])(regeneratorRuntime.mark((function e(t){var a,r,n,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,a={where:{code:t}},e.next=4,this.queryAllData(g["e"],a);case 4:return r=e.sent,n=r.data,s=!(!n||!n.sQLFragment.code),e.abrupt("return",s);case 10:return e.prev=10,e.t0=e["catch"](0),e.abrupt("return",!1);case 13:case"end":return e.stop()}}),e,this,[[0,10]])})));function t(t){return e.apply(this,arguments)}return t}(),confirmEditModal:function(){var e=Object(i["a"])(regeneratorRuntime.mark((function e(){var t,a,r,n,s,i,o,l,c,d,u,m,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.$refs.editModalFormVueComponent.validate();case 2:if(t=e.sent,t){e.next=7;break}return this.editModal.loading=!1,this.$Message.error(this.$t("common.rules.validateFailure")),e.abrupt("return");case 7:if(this.editModal.loading=!0,a=this.editModal.data,"add"!=this.modalConfirmActionType){e.next=22;break}return e.next=12,this.isCodeExists(this.editModal.data.code);case 12:if(i=e.sent,!i){e.next=17;break}return this.editModal.loading=!1,this.$Message.error(this.$t("system.sqlManager.rules.codeExist")),e.abrupt("return");case 17:r={data:a},o=r.data.roles,r.data.roles={set:o},n=g["a"],s="createdAt";case 22:return"edit"==this.modalConfirmActionType&&(l=a.code,c=a.content,d=a.description,u=a.roles,r={data:{code:l,content:c,description:d,roles:{set:u}}},n=g["f"],m={id:a.id},r.where=m,s="updatedAt"),e.prev=23,e.next=26,this.callGraphQlMution(n,r);case 26:p=e.sent,p.data.createSQLFragment||p.data.updateSQLFragment,this.$Message.success(this.$t("common.messages.saveSuccess")),this.gridApi.setSortModel([{colId:s,sort:"desc"}]),e.next=35;break;case 32:e.prev=32,e.t0=e["catch"](23),this.$Message.error(this.$t("common.messages.saveFailure"));case 35:return e.prev=35,this.cancelEditModal(),e.finish(35);case 38:case"end":return e.stop()}}),e,this,[[23,32,35,38]])})));function t(){return e.apply(this,arguments)}return t}(),openEditModal:function(e){var t=!1;"add"==e&&(this.editModal.data=this.getDefaultSqlFragment()),"edit"==e&&(this.editModal.data=Object.assign({},this.selectedRow),t=!0),this.modalConfirmActionType=e,this.$refs.editModalVueComponent.open(t),this.editModal.loading=!1},remove:function(){var e=Object(i["a"])(regeneratorRuntime.mark((function e(){var t,a,r,n,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=this.selectedRow,a=t.id,t.code,r={where:{id:a}},n=g["b"],e.prev=3,e.next=6,this.callGraphQlMution(n,r);case 6:s=e.sent,s.data.deleteSQLFragment,this.$Message.success(this.$t("common.messages.removeSuccess")),e.next=14;break;case 11:e.prev=11,e.t0=e["catch"](3),this.$Message.error(this.$t("common.messages.removeFailure"));case 14:return e.prev=14,this.disabledSomeAction(),this.gridApi.deselectAll(),this.gridApi.purgeServerSideCache(),e.finish(14);case 19:case"end":return e.stop()}}),e,this,[[3,11,14,19]])})));function t(){return e.apply(this,arguments)}return t}(),getDefaultSqlFragment:function(){return{code:"",content:"",description:"",roles:["USER"]}},enabledSomeAction:function(){this.actionsOptions.remove.disabled=!1,this.actionsOptions.edit.disabled=!1,this.actionsOptions.execute.disabled=!1},disabledSomeAction:function(){this.actionsOptions.remove.disabled=!0,this.actionsOptions.edit.disabled=!0,this.actionsOptions.execute.disabled=!0},onGridReady:function(e){var t=e.api,a=e.columnApi;this.gridApi=t,this.columnApi=a,this.gridApi.sizeColumnsToFit();var r=this.createDatasource();this.gridApi.setServerSideDatasource(r)},onSelectionChanged:function(e){e.type;var t=e.api,a=(e.columnApi,t.getSelectedRows());a.length>0?(this.selectedRow=a[0],this.enabledSomeAction()):this.disabledSomeAction()},callGraphQlMution:function(){var e=Object(i["a"])(regeneratorRuntime.mark((function e(t,a){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.$apollo.mutate({mutation:t,variables:a,client:h["client"]});case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)})));function t(t,a){return e.apply(this,arguments)}return t}(),queryAllData:function(){var e=Object(i["a"])(regeneratorRuntime.mark((function e(t,a){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.$apollo.query({query:t,variables:a,client:h["client"]});case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)})));function t(t,a){return e.apply(this,arguments)}return t}(),createDatasource:function(){var e=this;return{getRows:function(){var t=Object(i["a"])(regeneratorRuntime.mark((function t(a){var r,n,s,i,o,l,c,d,u;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return r=a.request,n=r.startRow,s=r.endRow-r.startRow,i=e.$agGenerateOrderByFromSortModel(r.sortModel),o=e.$agGenerateWhereFromFiltersModel(r.filterModel),l={skip:n,first:s,orderBy:i,where:o},t.prev=2,t.next=5,e.queryAllData(g["d"],l);case 5:c=t.sent,d=c.data,a.successCallback(d.list,d.total.aggregate.count),u=e.gridApi.getSelectedNodes(),u.length>0&&e.gridApi.deselectAll(),t.next=15;break;case 12:t.prev=12,t.t0=t["catch"](2),e.$Message.info(e.$t("common.messages.empty"));case 15:case"end":return t.stop()}}),t,null,[[2,12]])})));function a(e){return t.apply(this,arguments)}return a}()}}},mounted:function(){var e=Object(i["a"])(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Object(p["a"])("Role");case 2:t=e.sent,this.roleTypes=t.db_enumType;case 4:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},x=v,M=(a("dd9b"),a("2877")),y=Object(M["a"])(x,r,n,!1,null,"3d84cc90",null);t["default"]=y.exports},dd9b:function(e,t,a){"use strict";var r=a("338d"),n=a.n(r);n.a}}]);