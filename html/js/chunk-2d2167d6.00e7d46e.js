(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d2167d6"],{c34d:function(e,t,r){"use strict";r.r(t);var a=r("53ca"),n=(r("c5f6"),r("ac6a"),r("96cf"),r("1da1")),i=(r("4917"),r("3b2b"),r("23f4")),s=r("9b95"),o=r("9974b"),c=r("e7f7"),l=r("db25"),d=r("3595"),u=r("6ad0"),h=r("6689"),m=r("d2b0"),p=r("8eac"),g=(r("b893"),r("5946"));t["default"]={name:"sql-fragment-manager",components:{oneTabel:i["b"],actions:s["a"],editModal:p["a"]},mixins:[c["a"],l["a"],g["a"]],data:function(){var e=this;return{jsTypes:["string","number"],excuteModalLoading:!0,excutedSqlContent:"",formDynamic:{items:[]},showSqlExcuteModal:!1,sqlExcuteResult:"",roleTypes:[],modules:o["a"],gridOptions:this.$_.assign(this.$agGetDefaultGridOptions(),{onGridReady:e.onGridReady,onSelectionChanged:e.onSelectionChanged,pagination:!0,columnDefs:[{type:["rowNumberColumn"]},{headerName:"编码",field:"code",sort:"asc"},{headerName:"sql语句",field:"content",width:600},{headerName:this.$t("common.labels.createdAt"),field:"createdAt",cellRendererFramework:d["a"],filter:"agDateColumnFilter",width:200},{headerName:this.$t("common.labels.updatedAt"),cellRendererFramework:d["a"],field:"updatedAt",filter:"agDateColumnFilter",width:200},{headerName:this.$t("common.labels.description"),field:"description",filter:"agTextColumnFilter"}]}),gridApi:null,columnApi:null,selectedRow:null,modalConfirmActionType:"add",actionsOptions:{add:{visible:!0,disabled:!1,loading:!1},edit:{visible:!0,disabled:!0},remove:{visible:!0,disabled:!0},execute:{visible:!0,disabled:!0}},editModal:{loading:!1,visible:!1,data:e.getDefaultSqlFragment(),rules:{code:[{required:!0,message:this.$t("system.sqlManager.rules.code"),trigger:"blur"},{message:this.$t("system.sqlManager.rules.codeValidateError"),trigger:"change",validator:function(e,t,r){var a=new RegExp(/(^[A-Za-z]+[A-Za-z0-9_]+$)/gi);a.test(t)?r():r(new Error)}}],content:[{required:!0,message:this.$t("system.sqlManager.rules.sqlContent"),trigger:"blur"},{message:this.$t("system.sqlManager.rules.sqlContent"),validator:function(e,t,r){var a=t.trim();";"!=a.charAt(a.length-1)||a.match(/\;/g).length>1?r(new Error):r()},trigger:"change"}],roles:[{required:!0,message:this.$t("system.sqlManager.rules.role"),trigger:"change",type:"array",min:1}]}}}},methods:{openSqlExcuteModal:function(){this.excutedSqlContent=this.selectedRow.content;var e=this.getVariablesByParseSql(this.excutedSqlContent);this.formDynamic.items=e,this.showSqlExcuteModal=!0},getVariablesByParseSql:function(e){var t,r=/(\@)(\w+)/g,a=e.match(r);return t=a&&a.length>0?a.map((function(e){var t=e.substring(1);return{variableName:t,variableValue:"",variableJsType:"string"}})):[],t},okSqlExcuteModal:function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(){var t,r,a,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=this.selectedRow.code,r={},this.formDynamic.items.forEach((function(e){if(e.variableValue.trim().length>0){var t=e.variableValue;r[e.variableName]="number"==e.variableJsType?Number(t):t}})),e.prev=3,e.next=6,this.callGraphQlMution(m["c"],{code:t,params:r});case 6:a=e.sent,n=a.data.db_SQLFragmentCheck,this.sqlExcuteResult=JSON.stringify(n),e.next=14;break;case 11:e.prev=11,e.t0=e["catch"](3),this.sqlExcuteResult=JSON.stringify(e.t0.networkError.extensions.exception[0].message);case 14:case"end":return e.stop()}}),e,this,[[3,11]])})));function t(){return e.apply(this,arguments)}return t}(),cancelSqlExcuteModal:function(){this.showSqlExcuteModal=!1,this.sqlExcuteResult="",this.formDynamic.items=[],this.excutedSqlContent="",this.disabledSomeAction(),this.gridApi.deselectAll()},getRoleDisplayText:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return e&&this.existI18N(e)?this.$t(e):t},existI18N:function(e){var t=this.$t(e);return!0===this.$te(e)&&"object"!==Object(a["a"])(t)},cancelEditModal:function(){this.disabledSomeAction(),this.$refs.editModalFormVueComponent.resetFields(),this.$refs.editModalVueComponent.close(),this.gridApi.deselectAll()},isCodeExists:function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(t){var r,a,n,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,r={where:{code:t}},e.next=4,this.queryAllData(m["e"],r);case 4:return a=e.sent,n=a.data,i=!(!n||!n.sQLFragment.code),e.abrupt("return",i);case 10:return e.prev=10,e.t0=e["catch"](0),e.abrupt("return",!1);case 13:case"end":return e.stop()}}),e,this,[[0,10]])})));function t(t){return e.apply(this,arguments)}return t}(),confirmEditModal:function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(){var t,r,a,n,i,s,o,c,l,d,u,h,p;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.$refs.editModalFormVueComponent.validate();case 2:if(t=e.sent,t){e.next=7;break}return this.editModal.loading=!1,this.$Message.error(this.$t("common.rules.validateFailure")),e.abrupt("return");case 7:if(this.editModal.loading=!0,r=this.editModal.data,"add"!=this.modalConfirmActionType){e.next=22;break}return e.next=12,this.isCodeExists(this.editModal.data.code);case 12:if(s=e.sent,!s){e.next=17;break}return this.editModal.loading=!1,this.$Message.error(this.$t("system.sqlManager.rules.codeExist")),e.abrupt("return");case 17:a={data:r},o=a.data.roles,a.data.roles={set:o},n=m["a"],i="createdAt";case 22:return"edit"==this.modalConfirmActionType&&(c=r.code,l=r.content,d=r.description,u=r.roles,a={data:{code:c,content:l,description:d,roles:{set:u}}},n=m["f"],h={id:r.id},a.where=h,i="updatedAt"),e.prev=23,e.next=26,this.callGraphQlMution(n,a);case 26:p=e.sent,p.data.createSQLFragment||p.data.updateSQLFragment,this.$Message.success(this.$t("common.messages.saveSuccess")),this.gridApi.setSortModel([{colId:i,sort:"desc"}]),e.next=35;break;case 32:e.prev=32,e.t0=e["catch"](23),this.$Message.error(this.$t("common.messages.saveFailure"));case 35:return e.prev=35,this.cancelEditModal(),e.finish(35);case 38:case"end":return e.stop()}}),e,this,[[23,32,35,38]])})));function t(){return e.apply(this,arguments)}return t}(),openEditModal:function(e){var t=!1;"add"==e&&(this.editModal.data=this.getDefaultSqlFragment()),"edit"==e&&(this.editModal.data=Object.assign({},this.selectedRow),t=!0),this.modalConfirmActionType=e,this.$refs.editModalVueComponent.open(t),this.editModal.loading=!1},remove:function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(){var t,r,a,n,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t=this.selectedRow,r=t.id,t.code,a={where:{id:r}},n=m["b"],e.prev=3,e.next=6,this.callGraphQlMution(n,a);case 6:i=e.sent,i.data.deleteSQLFragment,this.$Message.success(this.$t("common.messages.removeSuccess")),e.next=14;break;case 11:e.prev=11,e.t0=e["catch"](3),this.$Message.error(this.$t("common.messages.removeFailure"));case 14:return e.prev=14,this.disabledSomeAction(),this.gridApi.deselectAll(),this.gridApi.purgeServerSideCache(),e.finish(14);case 19:case"end":return e.stop()}}),e,this,[[3,11,14,19]])})));function t(){return e.apply(this,arguments)}return t}(),getDefaultSqlFragment:function(){return{code:"",content:"",description:"",roles:["USER"]}},enabledSomeAction:function(){this.actionsOptions.remove.disabled=!1,this.actionsOptions.edit.disabled=!1,this.actionsOptions.execute.disabled=!1},disabledSomeAction:function(){this.actionsOptions.remove.disabled=!0,this.actionsOptions.edit.disabled=!0,this.actionsOptions.execute.disabled=!0},onGridReady:function(e){var t=e.api,r=e.columnApi;this.gridApi=t,this.columnApi=r,this.gridApi.sizeColumnsToFit();var a=this.createDatasource();this.gridApi.setServerSideDatasource(a)},onSelectionChanged:function(e){e.type;var t=e.api,r=(e.columnApi,t.getSelectedRows());r.length>0?(this.selectedRow=r[0],this.enabledSomeAction()):this.disabledSomeAction()},callGraphQlMution:function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(t,r){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.$apollo.mutate({mutation:t,variables:r,client:h["client"]});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}(),queryAllData:function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(t,r){var a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.$apollo.query({query:t,variables:r,client:h["client"]});case 2:return a=e.sent,e.abrupt("return",a);case 4:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}(),createDatasource:function(){var e=this;return{getRows:function(){var t=Object(n["a"])(regeneratorRuntime.mark((function t(r){var a,n,i,s,o,c,l,d,u;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return a=r.request,n=a.startRow,i=a.endRow-a.startRow,s=e.$agGenerateOrderByFromSortModel(a.sortModel),o=e.$agGenerateWhereFromFiltersModel(a.filterModel),c={skip:n,first:i,orderBy:s,where:o},t.prev=2,t.next=5,e.queryAllData(m["d"],c);case 5:l=t.sent,d=l.data,r.successCallback(d.list,d.total.aggregate.count),u=e.gridApi.getSelectedNodes(),u.length>0&&e.gridApi.deselectAll(),t.next=15;break;case 12:t.prev=12,t.t0=t["catch"](2),e.$Message.info(e.$t("common.messages.empty"));case 15:case"end":return t.stop()}}),t,null,[[2,12]])})));function r(e){return t.apply(this,arguments)}return r}()}}},mounted:function(){var e=Object(n["a"])(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Object(u["a"])("Role");case 2:t=e.sent,this.roleTypes=t.db_enumType;case 4:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()}}}]);